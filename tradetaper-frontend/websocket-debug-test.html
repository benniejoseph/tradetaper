<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Debug Test</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body>
    <h1>WebSocket Debug Test</h1>
    <div id="log" style="font-family: monospace; white-space: pre-wrap; border: 1px solid #ccc; padding: 10px; height: 500px; overflow-y: auto; background: #f9f9f9;"></div>
    <br>
    <div style="margin: 10px 0;">
        <button onclick="testBasicConnection()">1. Test Basic Connection</button>
        <button onclick="getTokenAndTest()">2. Get Token & Test Namespace</button>
        <button onclick="testDirectNamespace()">3. Test Direct Namespace</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <script>
        const logDiv = document.getElementById('log');
        let currentSocket = null;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
            logDiv.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }
        
        function clearLog() {
            logDiv.textContent = '';
        }
        
        function testBasicConnection() {
            log('ðŸš€ Testing basic Socket.IO connection...');
            
            if (currentSocket) {
                currentSocket.disconnect();
                currentSocket = null;
            }
            
            const socket = io('http://localhost:3001', {
                transports: ['polling', 'websocket'],
                timeout: 10000,
                forceNew: true
            });
            
            const connectionTimeout = setTimeout(() => {
                log('Connection timeout after 10 seconds', 'error');
                socket.disconnect();
            }, 10000);
            
            socket.on('connect', () => {
                clearTimeout(connectionTimeout);
                log(`Basic connection successful! Socket ID: ${socket.id}`, 'success');
                log(`Transport: ${socket.io.engine.transport.name}`, 'success');
                
                // Test ping
                socket.emit('ping', 'test');
                log('Sent ping to server');
                
                setTimeout(() => {
                    socket.disconnect();
                    log('Disconnected from main server');
                }, 2000);
            });
            
            socket.on('connect_error', (error) => {
                clearTimeout(connectionTimeout);
                log(`Basic connection failed: ${error.message}`, 'error');
                log(`Error type: ${error.type}`, 'error');
                log(`Error description: ${error.description}`, 'error');
            });
            
            socket.on('disconnect', (reason) => {
                log(`Disconnected: ${reason}`);
            });
            
            socket.on('pong', (data) => {
                log(`Received pong: ${data}`, 'success');
            });
        }
        
        async function getTokenAndTest() {
            log('ðŸ” Getting authentication token...');
            
            try {
                const response = await fetch('http://localhost:3001/api/v1/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: 'demouser@tradetaper.com',
                        password: 'demopassword'
                    })
                });
                
                if (!response.ok) {
                    log(`Failed to get token: ${response.status} ${response.statusText}`, 'error');
                    const errorText = await response.text();
                    log(`Error response: ${errorText}`, 'error');
                    return;
                }
                
                const authData = await response.json();
                const token = authData.accessToken;
                
                if (!token) {
                    log('No access token in response', 'error');
                    log(`Response: ${JSON.stringify(authData)}`, 'error');
                    return;
                }
                
                log(`Token obtained: ${token.substring(0, 20)}...`, 'success');
                
                // Test namespace with token
                testNamespaceWithToken(token);
                
            } catch (error) {
                log(`Token request failed: ${error.message}`, 'error');
            }
        }
        
        function testNamespaceWithToken(token) {
            log('ðŸ”Œ Testing /trades namespace with authentication...');
            
            if (currentSocket) {
                currentSocket.disconnect();
            }
            
            // Method 1: Connect to namespace directly
            currentSocket = io('http://localhost:3001/trades', {
                transports: ['polling', 'websocket'],
                auth: { 
                    token: token 
                },
                query: { 
                    token: token 
                },
                extraHeaders: {
                    'Authorization': `Bearer ${token}`
                },
                timeout: 15000,
                forceNew: true
            });
            
            const namespaceTimeout = setTimeout(() => {
                log('Namespace connection timeout after 15 seconds', 'error');
                if (currentSocket) currentSocket.disconnect();
            }, 15000);
            
            currentSocket.on('connect', () => {
                clearTimeout(namespaceTimeout);
                log(`Namespace connection successful! Socket ID: ${currentSocket.id}`, 'success');
                log(`Transport: ${currentSocket.io.engine.transport.name}`, 'success');
                log('Connected to /trades namespace', 'success');
            });
            
            currentSocket.on('authenticated', (data) => {
                log(`Authentication successful!`, 'success');
                log(`User data: ${JSON.stringify(data)}`, 'success');
            });
            
            currentSocket.on('connection-status', (data) => {
                log(`Connection status: ${JSON.stringify(data)}`, 'success');
            });
            
            currentSocket.on('connect_error', (error) => {
                clearTimeout(namespaceTimeout);
                log(`Namespace connection failed: ${error.message}`, 'error');
                log(`Error type: ${error.type}`, 'error');
                log(`Error description: ${error.description}`, 'error');
                log(`Error context: ${JSON.stringify(error.context)}`, 'error');
            });
            
            currentSocket.on('error', (error) => {
                log(`Socket error: ${JSON.stringify(error)}`, 'error');
            });
            
            currentSocket.on('disconnect', (reason) => {
                log(`Namespace disconnected: ${reason}`);
            });
            
            // Test sending a message after connection
            setTimeout(() => {
                if (currentSocket && currentSocket.connected) {
                    currentSocket.emit('test-message', { message: 'Hello from test client!' });
                    log('ðŸ“¤ Sent test message to namespace');
                }
            }, 3000);
        }
        
        function testDirectNamespace() {
            log('ðŸ”— Testing direct namespace connection (no auth)...');
            
            if (currentSocket) {
                currentSocket.disconnect();
            }
            
            currentSocket = io('http://localhost:3001/trades', {
                transports: ['polling', 'websocket'],
                timeout: 10000,
                forceNew: true
            });
            
            currentSocket.on('connect', () => {
                log(`Direct namespace connection successful! Socket ID: ${currentSocket.id}`, 'success');
            });
            
            currentSocket.on('connect_error', (error) => {
                log(`Direct namespace connection failed: ${error.message}`, 'error');
                log(`This is expected if authentication is required`, 'warning');
            });
            
            currentSocket.on('disconnect', (reason) => {
                log(`Direct namespace disconnected: ${reason}`);
            });
        }
        
        // Initial setup
        log('ðŸš€ WebSocket Debug Test Ready');
        log('ðŸ’¡ Click "Test Basic Connection" first to verify Socket.IO server');
        log('ðŸ’¡ Then "Get Token & Test Namespace" to test authenticated connection');
        log('ðŸ’¡ Use browser dev tools (F12) for additional debugging info');
    </script>
</body>
</html> 